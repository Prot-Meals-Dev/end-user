<div class="container-fluid">
    <div class="summary-container">
        <div class="img">
            <img src="/logo.png" alt="">
        </div>
        <!-- Order Summary Card -->

        <div *ngIf="isLoading" class="d-flex justify-content-center align-items-center" style="height: 200px;">
            <div class="spinner-border text-danger" role="status" style="width: 4rem; height: 4rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div *ngIf="!isLoading" class="card-box">
            <div class="card-header">Order Summary</div>

            <div class="meal-types">{{ mealTypes.join(' $ ') }}</div>

            <div class="info-line">
                <span class="label">Start from:</span>
                <span class="value">{{ formattedStartDate }}</span>
            </div>
            <div class="info-line">
                <span class="label">End Date:</span>
                <span class="value">{{ formattedEndDate }}</span>
            </div>
            <div class="info-line">
                <span class="label">Days Choosen:</span>
                <span class="value">{{ selectedDays.join(',') }}</span>
            </div>

            <div class="coupon d-flex gap-2">
                <input class="form-control" [(ngModel)]="couponCode" placeholder="Enter Coupon" type="text">
                <button type="button" class="btn btn-danger" (click)="applyCoupon()">Apply</button>
            </div>

            <div *ngIf="discountAmount > 0" class="mt-2 text-success">
                Discount Applied: - Rs {{ discountAmount }}
            </div>

            <div class="card-bottom">
                <span class="payable-label">Payable Amount:</span>
                <span class="payable-value">Rs {{ finalPayable }}</span>
            </div>
        </div>

        <!-- Delivery Details Card -->
        <div *ngIf="!isLoading" class="card-box">
            <div class="card-header">Delivery Details</div>

            <div class="info-line">
                <span class="label">Name:</span>
                <span class="value">{{ userDetails?.name }}</span>
            </div>
            <div class="info-line">
                <span class="label">Contact Number:</span>
                <span class="value">{{ userDetails?.phone }}</span>
            </div>
            <div class="info-line">
                <span class="label">Address:</span>
                <span class="value">{{ userDetails?.address }}</span>
            </div>

            <div class="card-bottom center">
                <button class="change-btn" (click)="changeAddress(editDeliveryModal)">Change Delivery Details</button>
            </div>
        </div>
    </div>

    <div class="submit-container">
        <button class="submit-btn" (click)="submitOrder()">Submit</button>
    </div>
</div>

<ng-template #editDeliveryModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">Edit Delivery Details</h4>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
    </div>

    <form [formGroup]="editForm" (ngSubmit)="saveDeliveryDetails(modal)">
        <div class="modal-body">

            <div class="mb-3">
                <label class="form-label">Name</label>
                <input type="text" formControlName="name" class="form-control"
                    [ngClass]="{'is-invalid': editForm.get('name')?.touched && editForm.get('name')?.invalid}" />
                <div *ngIf="editForm.get('name')?.touched && editForm.get('name')?.invalid" class="invalid-feedback">
                    <small *ngIf="editForm.get('name')?.errors?.['required']">
                        Name is required.
                    </small>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Contact Number</label>
                <input type="text" formControlName="phone" class="form-control"
                    [ngClass]="{'is-invalid': editForm.get('phone')?.touched && editForm.get('phone')?.invalid}" />
                <div *ngIf="editForm.get('phone')?.touched && editForm.get('phone')?.invalid" class="invalid-feedback">
                    <small *ngIf="editForm.get('phone')?.errors?.['required']">
                        Phone number is required.
                    </small>
                    <small *ngIf="editForm.get('phone')?.errors?.['pattern']">
                        Enter a valid number (10 digits or +91XXXXXXXXXX).
                    </small>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea formControlName="address" class="form-control"
                    [ngClass]="{'is-invalid': editForm.get('address')?.touched && editForm.get('address')?.invalid}"></textarea>
                <div *ngIf="editForm.get('address')?.touched && editForm.get('address')?.invalid"
                    class="invalid-feedback">
                    <small *ngIf="editForm.get('address')?.errors?.['required']">
                        Address is required.
                    </small>
                </div>
            </div>

        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Cancel</button>
            <button type="submit" class="btn btn-danger" [disabled]="editForm.invalid">Save</button>
        </div>
    </form>
</ng-template>